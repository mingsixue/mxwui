import{COLOR,hexToRGBA}from"../utils/common";import lunisolar from"./lib/lunisolar";import festivals from"./lib/festivals-short.zh-cn";lunisolar.Markers.add(festivals,"节日");let WEEK_CHK_FOR_MONDAY=["周一","周二","周三","周四","周五","周六","周日"],WEEK_CHK_FOR_SUNDAY=["周日","周一","周二","周三","周四","周五","周六"];Component({properties:{visible:{type:Boolean,value:!1,observer(e){e&&this.init()}},selectionMode:{type:String,value:"single"},defaultValue:{type:String,value:""},startDate:{type:String,value:""},endDate:{type:String,value:""},min:{type:String,value:""},max:{type:String,value:""},weekStartsOn:{type:String,value:"Monday"},showLunar:{type:Boolean,value:!1},showSolarTerm:{type:Boolean,value:!1},showFestival:{type:Boolean,value:!1},title:{type:String,value:""},cancelText:{type:String,value:"取消"},cancelColor:{type:String,value:COLOR.PLACEHOLDER_COLOR},confirmText:{type:String,value:"确定"},confirmColor:{type:String,value:COLOR.THEME_COLOR},zIndex:{type:Number,value:1},isCloseMask:{type:Boolean,value:!0},THEME_COLOR:{type:String,value:COLOR.THEME_COLOR}},ready(){let e=WEEK_CHK_FOR_MONDAY;var t;"Sunday"===this.data.weekStartsOn&&(e=WEEK_CHK_FOR_SUNDAY),this.setData({weeks:e}),this.data.bgColor||(t=hexToRGBA(COLOR.THEME_COLOR,.15),this.setData({bgColor:t}))},methods:{init(){var{selectionMode:e,defaultValue:t,startDate:a,endDate:r}=this.data;if("single"==e){let e=t;e=e||this.formatDate(new Date),this.dealDays(e),t&&this.setData({value:t})}else"range"==e&&(a&&r?(t=a.replace(/-/g,"/"),e=this.dealDate(t),a=r.replace(/-/g,"/"),r=this.dealDate(a),this.setData({start:e,end:r}),this.dealDays(t)):(a=this.formatDate(new Date),this.dealDays(a)))},dealDate(e){e=e.replace(/-/g,"/");var e=new Date(e),t=e.getFullYear(),a=e.getMonth()+1,r=e.getDate(),s=new Date(t,a,0);let n={year:t,month:a,monthStr:a<10?"0"+a:a,day:r,dayStr:r<10?"0"+r:r,week:e.getDay(),days:s.getDate(),dates:e};return(this.data.showLunar||this.data.showSolarTerm||this.data.showFestival)&&(t=this.dealLunar(n),n={...n,...t}),(this.data.value||this.data.defaultValue)==`${n.year}-${n.monthStr}-`+n.dayStr&&(n.checked=!0),n.id=""+n.year+n.month+n.day,n},dealLunar(e){var t={},e=lunisolar(e.year+`/${e.month}/`+e.day);let a="",r=(this.data.showLunar&&"初一"==(a=e.lunar.getDayName())&&(a=e.lunar.getMonthName()),""),s=(this.data.showSolarTerm&&(r=e.solarTerm?.toString())&&(t.solarTerm=!0,t.color=this.data.themeColor||COLOR.THEME_COLOR),"");return this.data.showFestival&&(s=e.markers?.toString())&&(t.festival=!0,t.color=this.data.themeColor||COLOR.THEME_COLOR),t.label=s||r||a,t},dealDays(e){var{weekStartsOn:t,selectionMode:a,start:s,end:n}=this.data,i=this.dealDate(e),l=[];for(let e=1;e<=i.days;e++){var r=e<10?"0"+e:e,r=this.dealDate(`${i.year}-${i.monthStr}-`+r);l.push(r)}let h=0,o=("Sunday"==t&&0!==l[0].week?h=l[0].week:"Monday"==t&&1!==l[0].week&&(h=l[0].week-1)<0&&(h=6),i.year),d=i.month-1,y=(d<1&&(d=12,o=i.year-1),this.dealDate(`${o}-${d}-01`).days);for(let e=0;e<h;e++){var c=this.dealDate(`${o}-${d}-`+y);c.prev=!0,y--,l.unshift(c)}if(l.length<42){var D=42-l.length;let t=i.year,a=i.month+1,r=(12<a&&(a=1,t=i.year+1),1);for(let e=0;e<D;e++){var m=this.dealDate(`${t}-${a}-`+r);m.next=!0,r++,l.push(m)}}var e=this.formatDate(i.dates,"YYYY"),t=this.formatDate(i.dates,"YYYY-MM"),g=this.formatDate(i.dates,"YYYY年M月"),v=this.formatDate(i.dates,"YYYY-MM"),u=this.formatDate(new Date),u=this.dealDate(u);if("range"==a){if(s&&n){let a=`${s.year}/${s.month}/`+s.day,r=`${n.year}/${n.month}/`+n.day;l.forEach(e=>{var t=e.year+`/${e.month}/`+e.day;this.isDateBetween(a,r,t)&&(e.range=!0),a==t&&(e.start=!0,e.checked=!0),r==t&&(e.end=!0,e.checked=!0)})}l.forEach(e=>{var t=e.year+`/${e.month}/`+e.day;e.disabled=this.isDateDisabled(t)})}else"single"==a&&l.forEach(e=>{var t=e.year+`/${e.month}/`+e.day;e.disabled=this.isDateDisabled(t)});this.setData({dayArr:l,currentYear:e,currentMonth:t,currentMonthStr:g,currentYearMonth:v,now:u,nowStr:""+u.year+u.month+u.day,days:i})},formatDate(e,t="YYYY-MM-DD"){let a={YYYY:e.getFullYear(),MM:("0"+(e.getMonth()+1)).slice(-2),DD:("0"+e.getDate()).slice(-2),HH:("0"+e.getHours()).slice(-2),mm:("0"+e.getMinutes()).slice(-2),ss:("0"+e.getSeconds()).slice(-2),M:String(e.getMonth()+1).slice(-2),D:String(e.getDate()).slice(-2),H:String(e.getHours()).slice(-2),m:String(e.getMinutes()).slice(-2),s:String(e.getSeconds()).slice(-2)};return t.replace(/(YYYY|MM|DD|HH|mm|ss|M|D|H|m|s)/g,e=>a[e])},handleMask(){var e;this.data.isCloseMask&&(e=this.formatDate(new Date),this.dealDays(e),this.setData({visible:!1}),this.triggerEvent("calendar_close",{type:"close"}))},handleCancel(){var e=this.formatDate(new Date);this.dealDays(e),this.setData({visible:!1}),this.triggerEvent("calendar_close",{type:"cancel"})},handleConfirm(){var{value:e,start:t,end:a,selectionMode:r}=this.data;if("single"==r)e&&this.triggerEvent("calendar_confirm",{type:"single",value:e});else if("range"==r)if(t&&a)this.triggerEvent("calendar_confirm",{type:"range",start:`${t.year}-${t.monthStr}-`+t.dayStr,end:`${a.year}-${a.monthStr}-`+a.dayStr});else if(t&&!a)return void wx.showToast({title:"请选择结束日期",icon:"none"});this.setData({visible:!1})},handlePrevYear(){var e=this.data.days,t=e.year-1;this.dealDays(t+`-${e.month}-01`)},handlePrevMonth(){var e=this.data.days;let t=e.year,a=e.month-1;a<1&&(a=12,t=e.year-1);e=`${t}-${a}-01`;this.dealDays(e)},handleNextMonth(){var e=this.data.days;let t=e.year,a=e.month+1;12<a&&(a=1,t=e.year+1);e=`${t}-${a}-01`;this.dealDays(e)},handleNextYear(){var e=this.data.days,t=e.year+1;this.dealDays(t+`-${e.month}-01`)},handleMonthChange(e){e=e.detail.value+"-01";this.dealDays(e)},handleDay(e){var{idx:e,item:t={},prev:a,next:r}=e.currentTarget.dataset;let{selectionMode:s,dayArr:n=[],start:i,end:l}=this.data;if(t.disabled)wx.showToast({title:"该日期不可选择",icon:"none"});else if("single"===s)a?(this.setData({value:`${t.year}-${t.monthStr}-`+t.dayStr}),this.handlePrevMonth()):r?(this.setData({value:`${t.year}-${t.monthStr}-`+t.dayStr}),this.handleNextMonth()):(a=n[e].checked,n.forEach(e=>{e.checked=!1}),n[e].checked=!a,this.setData({dayArr:[...n],value:n[e].checked?`${t.year}-${t.monthStr}-`+t.dayStr:""}));else if("range"===s){i&&l?(n.forEach(e=>{e.start=!1,e.end=!1,e.range=!1,e.checked=!1}),n[e].start=!0,n[e].checked=!0,i=n[e],l=null):i?l||(n[e].end=!0,n[e].checked=!0,l=n[e]):(n[e].start=!0,n[e].checked=!0,i=n[e]);r=""+i.year+i.monthStr+i.dayStr,a=l&&l.year&&""+l.year+l.monthStr+l.dayStr;if(i&&l&&a<r&&(t=i,i=l,l=t,n.forEach(e=>{e.start=!1,e.end=!1,e.range=!1,e.checked=!1}),n.forEach(e=>{e.month==i.month&&e.day==i.day?(e.start=!0,e.checked=!0):e.month==l.month&&e.day==l.day&&(e.end=!0,e.checked=!0)})),i&&l){let a=`${i.year}/${i.month}/`+i.day,r=`${l.year}/${l.month}/`+l.day;n.forEach(e=>{var t=e.year+`/${e.month}/`+e.day;this.isDateBetween(a,r,t)&&(e.range=!0)})}this.setData({start:i,end:l,dayArr:[...n]})}},isDateBetween(e,t,a){e=new Date(e),t=new Date(t),a=new Date(a);e=e.getTime(),t=t.getTime(),a=a.getTime();return e<=a&&a<=t},isDateDisabled(e){let{min:t,max:a}=this.data;var r,s;return e=new Date(e),t&&a?(t=t.replace(/-/g,"/"),a=a.replace(/-/g,"/"),r=new Date(t+" 00:00:00"),s=new Date(a+" 00:00:00"),!(r<=e&&e<=s)):t&&!a?(t=t.replace(/-/g,"/"),!(new Date(t+" 00:00:00")<=e)):!(t||!a||(a=a.replace(/-/g,"/"),e<=new Date(a+" 00:00:00")))}}});